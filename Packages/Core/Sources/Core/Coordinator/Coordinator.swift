//
//  Coordinator.swift
//  Core
//
//  Created by Любченко Станислав Валерьевич on 12.02.2026.
//

import UIKit

/// Базовый абстрактный класс координатора.
///
/// Является связующим звеном между инфраструктурой навигации (Роутером) и навигационной логикой (Координатором).
/// Управляет жизненным циклом потока и обеспечивает типобезопасный доступ к методам навигации.
///
/// - Generic Parameter R: Тип роутера (`Routing`), с которым работает данный координатор.
///   Это обеспечивает строгую типизацию: например, координатор авторизации будет иметь доступ
///   только к методам `StackRouting`, но не `TabRouting`.
@MainActor
open class Coordinator<R: Routing> {

    /// Capability-токен, подтверждающий право запустить координатор.
    ///
    /// Экземпляр этого типа создается только внутри `Core` (через `internal init`),
    /// поэтому внешние модули не могут вручную вызвать `start(_:)`.
    ///
    /// - Note: Токен параметризован типом роутера, чтобы исключить смешивание прав
    ///   запуска между координаторами разных типов (`StackRouter`, `TabRouter`, `WindowRouter` и т.д.).
    public struct Start<Router: Routing> {
        internal init() {}
    }

    /// Псевдоним capability-токена запуска для текущего типа координатора.
    ///
    /// Используется в сигнатуре `start(_:)` наследников как единый,
    /// читаемый контракт запуска (`override func start(_ capability: StartCapability)`).
    public typealias StartCapability = Start<R>

    /// Роутер, через который осуществляется навигация.
    ///
    /// - Warning: Не обращайтесь к этому свойству в методе `init`. В момент инициализации роутер еще не привязан.
    ///   Безопасный доступ гарантирован только внутри метода `start(_:)` и после него.
    public var router: R? {
        return _router
    }

    public init() {}

    // MARK: - Internal Infrastructure Logic

    /// Служебная точка входа для связывания Роутера и Координатора.
    ///
    /// Этот метод выполняет три критические функции:
    /// 1. **Dependency Injection:** Принимает и сохраняет ссылку на роутер (`R`), с которым будет работать координатор.
    /// 2. **Lifecycle Management:** Гарантирует, что координатор начнет работу только тогда, когда роутер полностью готов (инициализирован или загружен).
    /// 3. **Flow Trigger:** Автоматически запускает пользовательскую логику переопределенного метода `start(_:)`.
    ///
    /// - Parameter router: Роутер, который инициирует запуск. Обычно передается `self` из `viewDidLoad` или `init` роутера.
    ///
    /// - Note: **Ограничение доступа (`internal`):**
    ///   Этот метод доступен только внутри пакета `Core`. Это архитектурная защита, предотвращающая
    ///   ручной запуск координатора из Фабрик, Компоузеров или других модулей.
    ///   Разработчик фичи не должен заботиться о связывании — это происходит автоматически внутри инфраструктуры Роутера.
    internal func start(with router: R) {
        // Защита от повторного связывания
        guard _router == nil else { return }

        _router = router
        start(.init())
    }

    // MARK: - Public API (For Override)

    /// Точка входа в бизнес-логику навигации.
    ///
    /// В этом методе вы должны определить начальный экран флоу и отобразить его через `router`.
    ///
    /// - Parameter capability: Маркер права на запуск, который может создать только `Core`.
    ///   Благодаря этому метод невозможно корректно вызвать вручную вне инфраструктуры роутеров.
    ///
    /// - Warning: **Требование к реализации:** Этот метод ОБЯЗАН быть переопределен в классе-наследнике.
    ///   Базовая реализация вызывает `fatalError`.
    ///
    /// - Warning: **Ручной вызов запрещен:** Этот метод должен вызываться только роутером через `start(with:)`.
    ///   Внешние модули не могут создать `StartCapability`, поэтому попытка ручного запуска блокируется на этапе компиляции.
    ///   Это гарантирует, что навигация начнется только тогда, когда UI и Router полностью готовы к работе.
    open func start(_ capability: StartCapability) {
        fatalError("Метод start(_:) должен быть переопределен в наследнике \(String(describing: self))")
    }

    // MARK: - Private members

    private weak var _router: R?
}
